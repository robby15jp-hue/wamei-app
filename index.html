<!-- 書道フォント -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">

<style>
  .shodo-wrap{margin:16px auto;max-width:820px;padding:14px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03)}
  .shodo-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .shodo-btn{background:#7c5cff;color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700}
  .shodo-ghost{background:#101633;color:#e8ecff;border:1px solid rgba(255,255,255,.15)}
  .shodo-input{flex:1;min-width:180px;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.06);color:inherit}
  #shodoCanvas{width:100%;max-width:820px;display:block;border-radius:12px;
    border:1px solid rgba(255,255,255,.15);background:#f6f2e8}
  .shodo-note{opacity:.7;font-size:12px;margin-top:6px}
</style>

<div class="shodo-wrap">
  <div class="shodo-row">
    <!-- フォールバック用の手入力 -->
    <input id="shodoManual" class="shodo-input" placeholder="描画したい漢字を手入力（拾えない時用）">
    <button class="shodo-btn" id="shodoRender">🖌️ 書道風で表示</button>
    <button class="shodo-btn shodo-ghost" id="shodoDownload">💾 画像を保存</button>
  </div>
  <div class="shodo-note">※ 現在の変換結果が見つかれば自動で描画／見つからない時は手入力して描画できます</div>
  <canvas id="shodoCanvas" width="1200" height="1600"></canvas>
</div>

<script>
/* ====== 書道レンダラ ====== */
const SHODO = (() => {
  const paper = (ctx,w,h) => {
    ctx.fillStyle = '#f6f2e8'; ctx.fillRect(0,0,w,h);
    for(let i=0;i<800;i++){
      const x=Math.random()*w, y=Math.random()*h, a=Math.random()*0.08+0.02;
      ctx.fillStyle=`rgba(120,110,90,${a})`;
      ctx.fillRect(x,y, Math.random()*1.2+0.2, Math.random()*1.2+0.2);
    }
    const g=ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'rgba(0,0,0,0.02)'); g.addColorStop(1,'rgba(0,0,0,0.05)');
    ctx.globalCompositeOperation='multiply'; ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
    ctx.globalCompositeOperation='source-over';
  };
  const fontReady = () => document.fonts ? document.fonts.ready : Promise.resolve();
  const drawText = async (ctx,w,h,text) => {
    await fontReady();
    const margin=w*0.08, boxW=w-margin*2, boxH=h-margin*2;
    const chars=[...text.trim()];
    const maxCols = chars.length<=3 ? 1 : (chars.length<=6?2:3);
    const rows = Math.ceil(chars.length/maxCols);
    const colW=boxW/maxCols, rowH=boxH/rows;
    const f=Math.min(colW,rowH)*0.9;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const passes=10;
    for(let p=0;p<passes;p++){
      ctx.globalAlpha=(p+1)/passes;
      ctx.filter=`blur(${(passes-p)*0.6}px)`;
      ctx.font=`900 ${f}px "Yuji Syuku", serif`;
      for(let i=0;i<chars.length;i++){
        const c=chars[i], col=i%maxCols, row=Math.floor(i/maxCols);
        const x=margin+col*colW+colW/2+(Math.random()-0.5)*2;
        const y=margin+row*rowH+rowH/2+(Math.random()-0.5)*2;
        ctx.fillStyle='#000'; ctx.fillText(c,x,y);
      }
    }
    ctx.filter='none'; ctx.globalAlpha=1;
    const hankoSize=Math.max(60, Math.min(w,h)*0.08);
    ctx.fillStyle='#b81c2c'; ctx.globalAlpha=0.9;
    ctx.fillRect(w-margin-hankoSize, h-margin-hankoSize, hankoSize, hankoSize);
    ctx.globalAlpha=1; ctx.fillStyle='#f6f2e8';
    ctx.font=`${hankoSize*0.5}px "Yuji Syuku", serif`;
    ctx.fillText('和名', w-margin-hankoSize/2, h-margin-hankoSize/2+2);
  };
  const render = (text) => {
    const cvs=document.getElementById('shodoCanvas'), ctx=cvs.getContext('2d');
    paper(ctx,cvs.width,cvs.height);
    if(text && /[\u4E00-\u9FFF]/.test(text)) drawText(ctx,cvs.width,cvs.height,text);
  };
  return { render };
})();

/* ====== 文字取得：強化版 ====== */
function findKanjiInDOM(){
  // 1) よくあるID
  const ids=['kanji','kanjiOutput','kanjiText','resultKanji','wamei','nameKanji'];
  for(const id of ids){
    const el=document.getElementById(id);
    const t=el && el.textContent ? el.textContent.trim() : '';
    if(/[\u4E00-\u9FFF]/.test(t)) return t;
  }
  // 2) CJKを含む要素を総当り（大きい＆太字っぽいものを優先）
  const all = Array.from(document.querySelectorAll('div,span,h1,h2,h3,p'));
  const cands = all.map(el=>{
    const t=(el.textContent||'').trim();
    const score =
      (/[^\x00-\x7F]/.test(t)?1:0) * 10 +
      (window.getComputedStyle(el).fontSize.replace('px','')|0) +
      (el.clientWidth*el.clientHeight)/1000;
    return {t,score};
  }).filter(o=> /[\u4E00-\u9FFF]/.test(o.t) && o.t.length<=12);
  if(cands.length){ cands.sort((a,b)=>b.score-a.score); return cands[0].t; }
  return '';
}

/* ====== 外部からも呼べるAPI ====== */
window.SHODO_RENDER = (text) => {
  SHODO.render(text || findKanjiInDOM() || document.getElementById('shodoManual').value.trim());
};

/* ====== ボタン動作・初期化 ====== */
document.getElementById('shodoRender').addEventListener('click', ()=>{
  window.SHODO_RENDER();
});
document.getElementById('shodoDownload').addEventListener('click', ()=>{
  const cvs=document.getElementById('shodoCanvas');
  const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='wamei-shodo.png'; a.click();
});
// 初期は半紙のみ
SHODO.render('');

// 変換結果の出現を監視して自動描画（ページ側の更新に追従）
const obs=new MutationObserver(()=>{ const k=findKanjiInDOM(); if(k) SHODO.render(k); });
obs.observe(document.body,{childList:true,subtree:true,characterData:true});
</script>
