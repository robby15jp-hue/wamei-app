<script>
/* ---------- 1) 実用辞書（読みやすさ最優先） ---------- */
const DICT = {
  // 男性定番
  "ken":   {kanji:"健",   reading:"けん",   meaning:"health, strength"},
  "david": {kanji:"大輝",  reading:"だいき", meaning:"great + shine"},
  "john":  {kanji:"譲",   reading:"じょう", meaning:"yielding, modesty"},
  "mike":  {kanji:"舞輝",  reading:"まいく", meaning:"graceful dance + shine"},
  "tom":   {kanji:"智",   reading:"とも",   meaning:"wisdom"},
  "alex":  {kanji:"新",   reading:"あれく", meaning:"renewal"},
  // 女性・中性
  "anna":  {kanji:"安奈",  reading:"あんな", meaning:"peace + elegance"},
  "sarah": {kanji:"咲良",  reading:"さら",  meaning:"to bloom + good"},
  "emma":  {kanji:"恵真",  reading:"えま",  meaning:"blessing + truth"},
  "lisa":  {kanji:"梨沙",  reading:"りさ",  meaning:"pear + sand (classic name pair)"},
  "kate":  {kanji:"恵都",  reading:"けいと", meaning:"blessing + city"},
  "maria": {kanji:"真理亜",reading:"まりあ", meaning:"truth + Asia (phonetic-classic)"}
};

/* ---------- 2) ポジティブ漢字プール（自動生成用） ---------- */
const POSITIVE = [
  {k:"大", m:"great"},
  {k:"健", m:"healthy"},
  {k:"輝", m:"shine"},
  {k:"翔", m:"soar"},
  {k:"優", m:"kind"},
  {k:"誠", m:"sincere"},
  {k:"愛", m:"love"},
  {k:"光", m:"light"},
  {k:"栄", m:"glory"},
  {k:"希", m:"hope"},
  {k:"真", m:"true"},
  {k:"慧", m:"wise"},
  {k:"美", m:"beauty"}
];

/* ---------- 3) ローマ字→片仮名（簡易ヘボン対応） ---------- */
function toKatakana(str){
  const s = str.trim().toLowerCase();
  if(!s) return "";
  // 濁点・拗音など最小限。厳密変換は将来置換を追加。
  const table = [
    ["kyo","キョ"],["kya","キャ"],["kyu","キュ"],
    ["sho","ショ"],["sha","シャ"],["shu","シュ"],
    ["cho","チョ"],["cha","チャ"],["chu","チュ"],
    ["ryo","リョ"],["rya","リャ"],["ryu","リュ"],
    ["jyo","ジョ"],["ja","ジャ"],["ju","ジュ"],["jo","ジョ"],
    ["shi","シ"],["chi","チ"],["tsu","ツ"],["fu","フ"],
    ["ka","カ"],["ki","キ"],["ku","ク"],["ke","ケ"],["ko","コ"],
    ["sa","サ"],["su","ス"],["se","セ"],["so","ソ"],
    ["ta","タ"],["te","テ"],["to","ト"],
    ["na","ナ"],["ni","ニ"],["nu","ヌ"],["ne","ネ"],["no","ノ"],
    ["ha","ハ"],["hi","ヒ"],["he","ヘ"],["ho","ホ"],
    ["ma","マ"],["mi","ミ"],["mu","ム"],["me","メ"],["mo","モ"],
    ["ra","ラ"],["ri","リ"],["ru","ル"],["re","レ"],["ro","ロ"],
    ["ya","ヤ"],["yu","ユ"],["yo","ヨ"],
    ["wa","ワ"],["wo","ヲ"],
    ["a","ア"],["i","イ"],["u","ウ"],["e","エ"],["o","オ"],
    ["n","ン"]
  ];
  let out = s;
  for(const [r,k] of table) out = out.replaceAll(r,k);
  return out.toUpperCase();
}

/* ---------- 4) 決定論ハッシュ（同名→同結果） ---------- */
function hash32(str){
  let h = 2166136261 >>> 0; // FNV-1a
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

/* ---------- 5) ハイブリッド生成 ---------- */
function generateWamei(raw){
  const key = raw.trim().toLowerCase();
  const kana = toKatakana(raw);
  if(!key) return null;

  // 1) 辞書優先（読みやすさ担保）
  if (DICT[key]) {
    const d = DICT[key];
    return {
      kanji: d.kanji,
      readingKana: d.reading,
      readingEn: raw,
      meanings: d.kanji.split("").map((ch,i)=>({k: ch, m: d.meaning.split("+")[i]?.trim() || d.meaning}))
    };
  }

  // 2) 安全自動生成（ポジティブ限定・2〜3文字）
  const h = hash32(key);
  const len = 2 + (h % 2); // 2 or 3
  let picked = [];
  let meanings = [];
  let x = h;
  for(let i=0;i<len;i++){
    x = (x * 1664525 + 1013904223) >>> 0; // LCG
    const idx = x % POSITIVE.length;
    picked.push(POSITIVE[idx].k);
    meanings.push(POSITIVE[idx].m);
  }
  // 読みは片仮名（簡易）。将来は音訓辞書を足して精度UP。
  return {
    kanji: picked.join(""),
    readingKana: kana || "—",
    readingEn: raw,
    meanings: picked.map((k,i)=>({k, m: meanings[i]}))
  };
}

/* ---------- 6) UI 結線 ---------- */
const $ = s => document.querySelector(s);

function applyI18n(lang){
  const dict = i18n[lang] || i18n.ja;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    el.textContent = dict[el.getAttribute("data-i18n")] || el.textContent;
  });
  document.querySelectorAll("[data-i18n-prefix]").forEach(el=>{
    const key = el.getAttribute("data-i18n-prefix");
    const base = dict[key] || "";
    const txt = el.textContent.replace(/^.*?:\s*/,"");
    el.textContent = `${base} ${txt}`;
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const key = el.getAttribute("data-i18n-placeholder");
    el.placeholder = dict[key] || el.placeholder;
  });
}

function showToast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}

function render(result){
  if(!result) return;
  $("#kanjiOutput").textContent = result.kanji;
  $("#kanaOutput").textContent = (i18n[currentLang]?.reading || "読み:") + " " + result.readingKana;
  $("#englishOutput").textContent = result.readingEn;

  const mc = $("#meaningContent");
  mc.innerHTML = "";
  result.meanings.forEach(({k,m})=>{
    const div = document.createElement("div");
    div.className = "meaning-item";
    div.innerHTML = `<span class="kanji-char">${k}</span> <span>${m}</span>`;
    mc.appendChild(div);
  });

  $("#result").classList.add("show");
}

let currentLang = "ja";
applyI18n(currentLang);

$("#languageSelect")?.addEventListener("change",(e)=>{
  currentLang = e.target.value;
  applyI18n(currentLang);
});

$("#generateBtn")?.addEventListener("click", ()=>{
  const name = $("#nameInput").value;
  $("#result").classList.remove("show");
  const r = generateWamei(name);
  render(r);
});

document.querySelectorAll(".example-tag").forEach(el=>{
  el.addEventListener("click", ()=>{
    $("#nameInput").value = el.dataset.name;
    $("#generateBtn").click();
  });
});

$("#copyBtn")?.addEventListener("click", async ()=>{
  const txt = `${$("#kanjiOutput").textContent} (${ $("#kanaOutput").textContent })`;
  try { await navigator.clipboard.writeText(txt); showToast((i18n[currentLang]?.copied)||"Copied!"); } catch {}
});

$("#shareBtn")?.addEventListener("click", async ()=>{
  try{
    await navigator.share({title:"WAMEI", text: $("#kanjiOutput").textContent, url: location.href});
    showToast((i18n[currentLang]?.shared)||"Shared!");
  }catch{}
});

$("#regenerateBtn")?.addEventListener("click", ()=>{
  // “別パターン”は将来: saltを変えて任意に切替（今は固定=決定論）
  showToast("Coming soon");
});
</script>
