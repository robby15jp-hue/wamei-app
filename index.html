<!-- â‘  æ›¸é“ãƒ•ã‚©ãƒ³ãƒˆï¼ˆGoogle Fontsï¼‰ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">

<style>
  /* â‘¡ UIï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼†ãƒœã‚¿ãƒ³ï¼‰ */
  .shodo-wrap{margin:16px auto;max-width:820px;padding:14px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03)}
  .shodo-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .shodo-btn{background:#7c5cff;color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700}
  .shodo-ghost{background:#101633;color:#e8ecff;border:1px solid rgba(255,255,255,.15)}
  #shodoCanvas{width:100%;max-width:820px;display:block;border-radius:12px;
    border:1px solid rgba(255,255,255,.15);background:#f6f2e8}
  .shodo-note{opacity:.7;font-size:12px;margin-top:6px}
</style>

<div class="shodo-wrap">
  <div class="shodo-row">
    <button class="shodo-btn" id="shodoRender">ğŸ–Œï¸ æ›¸é“é¢¨ã§è¡¨ç¤º</button>
    <button class="shodo-btn shodo-ghost" id="shodoDownload">ğŸ’¾ ç”»åƒã‚’ä¿å­˜</button>
    <span class="shodo-note">â€» ç¾åœ¨ã®å¤‰æ›çµæœï¼ˆæ¼¢å­—ï¼‰ã‚’åŠç´™é¢¨ã«æç”»ã—ã¦ä¿å­˜ã§ãã¾ã™</span>
  </div>
  <canvas id="shodoCanvas" width="1200" height="1600"></canvas>
</div>

<script>
/* ============ æ›¸é“ãƒ¬ãƒ³ãƒ€ãƒ© ============ */
const SHODO = (() => {
  const paper = (ctx,w,h) => {
    // åŠç´™ã®åœ°ï¼šã»ã‚“ã®ã‚Šã‚¯ãƒªãƒ¼ãƒ è‰²ï¼‹ç¹Šç¶­ã®ç²’
    ctx.fillStyle = '#f6f2e8';
    ctx.fillRect(0,0,w,h);
    // ç¹Šç¶­ãƒã‚¤ã‚ºï¼ˆè–„ã„ç°ç‚¹ï¼‰
    for(let i=0;i<800;i++){
      const x = Math.random()*w, y=Math.random()*h;
      const a = Math.random()*0.08 + 0.02;
      ctx.fillStyle = `rgba(120,110,90,${a})`;
      ctx.fillRect(x,y, Math.random()*1.2+0.2, Math.random()*1.2+0.2);
    }
    // ç½«ç·šã£ã½ã„æ°´å¢¨ãƒ ãƒ©ï¼ˆè–„ã„æ¨ªã‚°ãƒ©ãƒ‡ï¼‰
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'rgba(0,0,0,0.02)');
    g.addColorStop(1,'rgba(0,0,0,0.05)');
    ctx.fillStyle=g; ctx.globalCompositeOperation='multiply';
    ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='source-over';
  };

  // æ–‡å­—ã‚’å¤ªç­†ã§ï¼šãƒ•ã‚©ãƒ³ãƒˆæº–å‚™
  const fontReady = () => document.fonts ? document.fonts.ready : Promise.resolve();

  // æ–‡å­—ã®æç”»ï¼ˆã«ã˜ã¿ï¼†ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰
  const drawText = async (ctx,w,h,text) => {
    await fontReady();
    // æ å†…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    const margin = w*0.08;
    const boxW = w - margin*2;
    const boxH = h - margin*2;

    // æ–‡å­—ã‚µã‚¤ã‚ºã‚’è‡ªå‹•èª¿æ•´ï¼ˆç¸¦çµ„ã¿é¢¨ï¼æ”¹è¡Œã‚’å…¥ã‚Œã¦ä¸­å¤®å¯„ã›ï¼‰
    const chars = [...text.trim()];
    const maxCols = chars.length<=3 ? 1 : (chars.length<=6?2:3);
    const rows = Math.ceil(chars.length / maxCols);
    const colW = boxW / maxCols;
    const rowH = boxH / rows;

    // ãŠãŠã‚ˆãã®å­—é¢
    let f = Math.min(colW, rowH)*0.9;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#000'; ctx.strokeStyle='#000';

    // ã¼ã‹ã—å±¤ã‚’é‡ã­ã¦â€œã«ã˜ã¿â€
    const passes = 10;
    for(let p=0;p<passes;p++){
      ctx.globalAlpha = (p+1)/passes; // ãƒ•ã‚§ãƒ¼ãƒ‰
      ctx.filter = `blur(${(passes-p)*0.6}px)`; // å¾ã€…ã«ã‚·ãƒ£ãƒ¼ãƒ—ã¸
      ctx.font = `900 ${f}px "Yuji Syuku", "Yuji Syuku Fallback", serif`;
      for(let i=0;i<chars.length;i++){
        const c = chars[i];
        const col = i % maxCols, row = Math.floor(i/maxCols);
        const x = margin + col*colW + colW/2 + (Math.random()-0.5)*2; // å¾®å¦™ãªæºã‚‰ã
        const y = margin + row*rowH + rowH/2 + (Math.random()-0.5)*2;
        ctx.fillText(c, x, y);
      }
    }
    ctx.filter='none'; ctx.globalAlpha=1;

    // æœ±å°ï¼ˆä»»æ„ï¼‰
    const hankoSize = Math.max(60, Math.min(w,h)*0.08);
    ctx.fillStyle='#b81c2c';
    ctx.globalAlpha=0.9;
    ctx.fillRect(w - margin - hankoSize, h - margin - hankoSize, hankoSize, hankoSize);
    ctx.globalAlpha=1;
    ctx.fillStyle='#f6f2e8';
    ctx.font = `${hankoSize*0.5}px "Yuji Syuku", serif`;
    ctx.fillText('å’Œå', w - margin - hankoSize/2, h - margin - hankoSize/2 + 2);
  };

  return {
    render: (text) => {
      const cvs = document.getElementById('shodoCanvas');
      const ctx = cvs.getContext('2d');
      const w = cvs.width, h = cvs.height;
      // ç”¨ç´™
      paper(ctx,w,h);
      if(!text){ return; }
      // æç”»
      drawText(ctx,w,h,text);
    },
    download: () => {
      const cvs = document.getElementById('shodoCanvas');
      const a = document.createElement('a');
      a.href = cvs.toDataURL('image/png');
      a.download = 'wamei-shodo.png';
      a.click();
    }
  };
})();

/* ============ ãƒœã‚¿ãƒ³å‹•ä½œ ============ */
function currentKanjiText(){
  // ã‚ãªãŸã®ãƒšãƒ¼ã‚¸å†…ã®æ¼¢å­—è¦ç´ ã‚’åºƒãæ¢ç´¢ï¼ˆidã®ã©ã‚Œã‹ãŒå­˜åœ¨ã™ã‚‹æƒ³å®šï¼‰
  const cand = ['kanji','kanjiOutput','kanjiText'];
  for(const id of cand){
    const el = document.getElementById(id);
    if(el && el.textContent && el.textContent.trim() !== 'â€”') return el.textContent.trim();
  }
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šä¸€ç•ªå¤§ãã„è¦‹å‡ºã—ã£ã½ã„è¦ç´ ã‹ã‚‰æ¼¢å­—ã‚’æ‹¾ã†
  const big = Array.from(document.querySelectorAll('h1,h2,div'))
    .sort((a,b)=> (b.clientHeight*b.clientWidth) - (a.clientHeight*a.clientWidth));
  for(const el of big){
    const t = (el.textContent||'').trim();
    if(t && t.length<=8 && /[\u4E00-\u9FFF]/.test(t)) return t;
  }
  return '';
}

document.getElementById('shodoRender').addEventListener('click', ()=>{
  SHODO.render(currentKanjiText());
});
document.getElementById('shodoDownload').addEventListener('click', SHODO.download);

// åˆå›ç©ºç´™
SHODO.render('');
</script>
