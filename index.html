<!-- ① 書道フォント（Google Fonts） -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">

<style>
  /* ② UI（キャンバス＆ボタン） */
  .shodo-wrap{margin:16px auto;max-width:820px;padding:14px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03)}
  .shodo-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .shodo-btn{background:#7c5cff;color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700}
  .shodo-ghost{background:#101633;color:#e8ecff;border:1px solid rgba(255,255,255,.15)}
  #shodoCanvas{width:100%;max-width:820px;display:block;border-radius:12px;
    border:1px solid rgba(255,255,255,.15);background:#f6f2e8}
  .shodo-note{opacity:.7;font-size:12px;margin-top:6px}
</style>

<div class="shodo-wrap">
  <div class="shodo-row">
    <button class="shodo-btn" id="shodoRender">🖌️ 書道風で表示</button>
    <button class="shodo-btn shodo-ghost" id="shodoDownload">💾 画像を保存</button>
    <span class="shodo-note">※ 現在の変換結果（漢字）を半紙風に描画して保存できます</span>
  </div>
  <canvas id="shodoCanvas" width="1200" height="1600"></canvas>
</div>

<script>
/* ============ 書道レンダラ ============ */
const SHODO = (() => {
  const paper = (ctx,w,h) => {
    // 半紙の地：ほんのりクリーム色＋繊維の粒
    ctx.fillStyle = '#f6f2e8';
    ctx.fillRect(0,0,w,h);
    // 繊維ノイズ（薄い灰点）
    for(let i=0;i<800;i++){
      const x = Math.random()*w, y=Math.random()*h;
      const a = Math.random()*0.08 + 0.02;
      ctx.fillStyle = `rgba(120,110,90,${a})`;
      ctx.fillRect(x,y, Math.random()*1.2+0.2, Math.random()*1.2+0.2);
    }
    // 罫線っぽい水墨ムラ（薄い横グラデ）
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'rgba(0,0,0,0.02)');
    g.addColorStop(1,'rgba(0,0,0,0.05)');
    ctx.fillStyle=g; ctx.globalCompositeOperation='multiply';
    ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='source-over';
  };

  // 文字を太筆で：フォント準備
  const fontReady = () => document.fonts ? document.fonts.ready : Promise.resolve();

  // 文字の描画（にじみ＆フェードイン）
  const drawText = async (ctx,w,h,text) => {
    await fontReady();
    // 枠内レイアウト
    const margin = w*0.08;
    const boxW = w - margin*2;
    const boxH = h - margin*2;

    // 文字サイズを自動調整（縦組み風＝改行を入れて中央寄せ）
    const chars = [...text.trim()];
    const maxCols = chars.length<=3 ? 1 : (chars.length<=6?2:3);
    const rows = Math.ceil(chars.length / maxCols);
    const colW = boxW / maxCols;
    const rowH = boxH / rows;

    // おおよその字面
    let f = Math.min(colW, rowH)*0.9;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#000'; ctx.strokeStyle='#000';

    // ぼかし層を重ねて“にじみ”
    const passes = 10;
    for(let p=0;p<passes;p++){
      ctx.globalAlpha = (p+1)/passes; // フェード
      ctx.filter = `blur(${(passes-p)*0.6}px)`; // 徐々にシャープへ
      ctx.font = `900 ${f}px "Yuji Syuku", "Yuji Syuku Fallback", serif`;
      for(let i=0;i<chars.length;i++){
        const c = chars[i];
        const col = i % maxCols, row = Math.floor(i/maxCols);
        const x = margin + col*colW + colW/2 + (Math.random()-0.5)*2; // 微妙な揺らぎ
        const y = margin + row*rowH + rowH/2 + (Math.random()-0.5)*2;
        ctx.fillText(c, x, y);
      }
    }
    ctx.filter='none'; ctx.globalAlpha=1;

    // 朱印（任意）
    const hankoSize = Math.max(60, Math.min(w,h)*0.08);
    ctx.fillStyle='#b81c2c';
    ctx.globalAlpha=0.9;
    ctx.fillRect(w - margin - hankoSize, h - margin - hankoSize, hankoSize, hankoSize);
    ctx.globalAlpha=1;
    ctx.fillStyle='#f6f2e8';
    ctx.font = `${hankoSize*0.5}px "Yuji Syuku", serif`;
    ctx.fillText('和名', w - margin - hankoSize/2, h - margin - hankoSize/2 + 2);
  };

  return {
    render: (text) => {
      const cvs = document.getElementById('shodoCanvas');
      const ctx = cvs.getContext('2d');
      const w = cvs.width, h = cvs.height;
      // 用紙
      paper(ctx,w,h);
      if(!text){ return; }
      // 描画
      drawText(ctx,w,h,text);
    },
    download: () => {
      const cvs = document.getElementById('shodoCanvas');
      const a = document.createElement('a');
      a.href = cvs.toDataURL('image/png');
      a.download = 'wamei-shodo.png';
      a.click();
    }
  };
})();

/* ============ ボタン動作 ============ */
function currentKanjiText(){
  // あなたのページ内の漢字要素を広く探索（idのどれかが存在する想定）
  const cand = ['kanji','kanjiOutput','kanjiText'];
  for(const id of cand){
    const el = document.getElementById(id);
    if(el && el.textContent && el.textContent.trim() !== '—') return el.textContent.trim();
  }
  // フォールバック：一番大きい見出しっぽい要素から漢字を拾う
  const big = Array.from(document.querySelectorAll('h1,h2,div'))
    .sort((a,b)=> (b.clientHeight*b.clientWidth) - (a.clientHeight*a.clientWidth));
  for(const el of big){
    const t = (el.textContent||'').trim();
    if(t && t.length<=8 && /[\u4E00-\u9FFF]/.test(t)) return t;
  }
  return '';
}

document.getElementById('shodoRender').addEventListener('click', ()=>{
  SHODO.render(currentKanjiText());
});
document.getElementById('shodoDownload').addEventListener('click', SHODO.download);

// 初回空紙
SHODO.render('');
</script>
